name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-matrix:
    name: Build ${{ matrix.platform_name }} libraries
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            c_compiler: gcc
            platform_name: linux
            archive_ext: tar.gz
            backend_flags: -DBANJO_CONFIG_X11_BACKEND=ON -DBANJO_CONFIG_ALSA_BACKEND=ON
          - os: windows-latest
            c_compiler: cl
            platform_name: windows
            archive_ext: zip
            backend_flags: -DBANJO_CONFIG_WIN32_BACKEND=ON -DBANJO_CONFIG_MME_BACKEND=ON
          - os: macos-latest
            c_compiler: clang
            platform_name: macos
            archive_ext: tar.gz
            backend_flags: -DBANJO_CONFIG_COCOA_BACKEND=ON -DBANJO_CONFIG_COREAUDIO_BACKEND=ON

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Install Linux dependencies
        if: matrix.platform_name == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libasound2-dev

      - name: Set version
        id: version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Configure CMake (Static)
        run: >
          cmake -B ${{ github.workspace }}/build-static
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_SHARED_LIBS=OFF
          -DBUILD_TESTING=OFF
          -DBANJO_BUILD_EXAMPLES=OFF
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install-static
          ${{ matrix.backend_flags }}
          -S ${{ github.workspace }}

      - name: Build Static Library
        run: cmake --build ${{ github.workspace }}/build-static --config Release

      - name: Install Static Library
        run: cmake --install ${{ github.workspace }}/build-static --config Release

      - name: Configure CMake (Shared)
        run: >
          cmake -B ${{ github.workspace }}/build-shared
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
          -DCMAKE_BUILD_TYPE=Release
          -DBUILD_SHARED_LIBS=ON
          -DBUILD_TESTING=OFF
          -DBANJO_BUILD_EXAMPLES=OFF
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install-shared
          ${{ matrix.backend_flags }}
          -S ${{ github.workspace }}

      - name: Build Shared Library
        run: cmake --build ${{ github.workspace }}/build-shared --config Release

      - name: Install Shared Library
        run: cmake --install ${{ github.workspace }}/build-shared --config Release

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: banjo-libs-${{ matrix.platform_name }}
          path: |
            install-static/
            install-shared/
          retention-days: 1

  package-artifacts:
    name: Package ${{ matrix.platform_name }} artifacts
    needs: build-matrix
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform_name: linux
            os: ubuntu-latest
            arch: x64
            archive_ext: tar.gz
          - platform_name: windows
            os: windows-latest
            arch: x64
            archive_ext: zip
          - platform_name: macos
            os: macos-latest
            arch: arm64
            archive_ext: tar.gz

    steps:
      - name: Checkout (for LICENSE)
        uses: actions/checkout@v3

      - name: Set version
        id: version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Packaging version: $VERSION"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: banjo-libs-${{ matrix.platform_name }}
          path: artifacts/

      - name: Create package directory
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          PKG_NAME="banjo-${VERSION}-${{ matrix.platform_name }}-${{ matrix.arch }}"
          mkdir -p "${PKG_NAME}"

          # Create directory structure
          mkdir -p "${PKG_NAME}/lib"
          mkdir -p "${PKG_NAME}/include"

          # Copy libraries (both static and shared)
          if [ "${{ matrix.platform_name }}" = "windows" ]; then
            # Windows: static lib, DLL, and import lib
            cp -r artifacts/install-static/lib/*.lib "${PKG_NAME}/lib/" 2>/dev/null || true
            cp -r artifacts/install-shared/bin/*.dll "${PKG_NAME}/lib/" 2>/dev/null || true
            cp -r artifacts/install-shared/lib/*.lib "${PKG_NAME}/lib/" 2>/dev/null || true
          else
            # Unix-like: .a for static, .so/.dylib for shared
            cp -r artifacts/install-static/lib/* "${PKG_NAME}/lib/" 2>/dev/null || true
            cp -r artifacts/install-shared/lib/* "${PKG_NAME}/lib/" 2>/dev/null || true
          fi

          # Copy headers
          cp -r artifacts/install-static/include/* "${PKG_NAME}/include/"

          # Copy LICENSE
          cp LICENSE "${PKG_NAME}/"

          echo "PKG_NAME=${PKG_NAME}" >> $GITHUB_ENV

      - name: Create tar.gz archive (Unix)
        if: matrix.archive_ext == 'tar.gz'
        run: |
          tar -czf "${PKG_NAME}.tar.gz" "${PKG_NAME}"

      - name: Create zip archive (Windows)
        if: matrix.archive_ext == 'zip'
        shell: pwsh
        run: |
          Compress-Archive -Path "$env:PKG_NAME" -DestinationPath "$env:PKG_NAME.zip"

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.platform_name }}
          path: banjo-*.${{ matrix.archive_ext }}
          retention-days: 1

  create-release:
    name: Create GitHub Release
    needs: package-artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Creating release for version: $VERSION (tag: $TAG_NAME)"

      - name: Create source archives
        run: |
          VERSION=${{ steps.version.outputs.version }}
          git archive --format=tar.gz --output="banjo-${VERSION}-source.tar.gz" --prefix="banjo-${VERSION}/" HEAD
          git archive --format=zip --output="banjo-${VERSION}-source.zip" --prefix="banjo-${VERSION}/" HEAD

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/

      - name: Organize artifacts
        run: |
          mkdir -p final-release/
          find release-artifacts/ -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} final-release/ \;
          mv banjo-*-source.* final-release/

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Create release notes
          cat > release-notes.md << 'EOF'
          ## Banjo ${VERSION}

          Pre-built binaries for Linux, Windows, and macOS, along with source archives.
          EOF

          # Replace variables in release notes
          sed -i "s/\${VERSION}/${VERSION}/g" release-notes.md

          # Create release
          TAG_NAME=${{ steps.version.outputs.tag_name }}
          gh release create "$TAG_NAME" \
            --title "Banjo $VERSION" \
            --notes-file release-notes.md \
            final-release/*
